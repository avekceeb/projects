<!DOCTYPE html>
<html lang="ru" xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Калькулятор</title>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"></meta>
        <script src='js/math.js' charset='utf-8'></script>
        <script src='js/doc.js' charset='utf-8'></script>
        <script src='js/svg.js' charset='utf-8'></script>
        <script src='js/chart.js' charset='utf-8'></script>
        <style>

body {
    margin: 10px;
    font-family: monospace;
}

.tab {
  overflow: hidden;
  border: 1px solid #ccc;
  background-color: #f1f1f1;
}

/* Style the buttons that are used to open the tab content */
.tab button {
  background-color: inherit;
  float: right;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 14px 16px;
  transition: 0.3s;
}

/* Change background color of buttons on hover */
.tab button:hover {
  background-color: #ddd;
}

/* Create an active/current tablink class */
.tab button.active {
  background-color: #ccc;
}

.tabcontent {
    display: none;
    padding: 0;
    border: 1px solid #ccc;
    margin: 10px auto;
}

.tabcontent h2 {
    background-color: #f0f0f0;
    padding: 5px;
    margin: 0;
    font-size: 16px;
    font-family: monospace;
    font-weight: normal;
}

ul.options {
    text-align: left;
    list-style: outside none none;
}

ul.options li {
    list-style-type: none;
    display: block;
    padding: 5px 0 0 0;
    margin: 0;
}

svg path {
    fill: none;
}

#univariate-tab {
    /* initially active */
    display: block;
}


#content {
    /* width: 880px;
    margin: auto;
    min-width: 880px; */
    text-align: center;
    border: solid 1px #d0d0d0;
    border-top: none;
}

#drawing-area {
    /* float: left; */
    display: inline-block;
    vertical-align: top;
    width: 530px;
    min-width: 500px;
}

#input-area {
    /* float: left; */
    display: inline-block;
    vertical-align: top;
    width: 350px;
    min-width: 350px;
}

#map {
    border: solid 1px #d0d0d0;
    margin: 10px;
}

        </style>

        <script type="text/javascript">
var chart;

function start() {
    chart = new Chart('map', 500, 400);
}

function showTab(evt, tab) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tab).style.display = "block";
    evt.currentTarget.className += " active";
    if (tab == 'angular-tab') {
        drawHorizontal();
    }
}

function parseAngularString(v) {
    v = '' + v;
    var h, m, s;
    // заменяем градусы, минуты, секунды - пробелами
    v = v.replace(/d|h|m|s|ч|г|м|с|\u00b0|\u2032|\u2033/g, ' ');
    // TODO: длинный минус UTF8
    v = v.replace(/\u2012\u2013|\u2014|\u{e28892}/g, "-");
    // запятую - на точку
    v = v.replace(/,/g, '.');
    v = v.trim();
    [h, m, s] = v.split(/\s+/g, 3);
    if (h === undefined || isNaN(parseInt(h))) {
        h = 0;
    }
    if (m === undefined || isNaN(parseInt(m))) {
        m = 0;
    }
    if (s === undefined || isNaN(parseFloat(s))) {
        s = 0;
    }
    return [parseInt(h), parseInt(m), parseFloat(s)];
}

function formatDMS(d, m, s) {
    return `${d.toFixed()}\u00b0 ${m.toFixed()}\u2032 ${s.toFixed(2)}\u2033`;
}

function formatHMS(h, m, s) {
    return `${h.toFixed()}h ${m.toFixed()}\u2032 ${s.toFixed(2)}\u2033`;
}

function translateAngular(hour, degree, hms, dms) {
    var elHours = docEl("#hours");
    var elDegrees = docEl("#degrees");
    var elDms = docEl("#dms");
    var elHms = docEl("#hms");
    var h=0, hm=0, hs=0, d=0, dm=0, ds=0, hrs=0, deg=0;
    if (hms != null) {
        [h, hm, hs] = parseAngularString(hms);
        hrs = hms2float(h, hm, hs);
        deg = hours2deg(hrs);
        [d, dm, ds] = deg2hms(deg);
    }
    if (dms != null) {
        [d, dm, ds] = parseAngularString(dms);
        deg = hms2float(d, dm, ds);
        hrs = deg2hours(deg);
        [h, hm, hs] = deg2hms(hrs);
    }
    if (hour != null) {
        hrs = parseFloat(hour);
        if (Number.isNaN(hrs)) {
            hrs = 0;
        }
        deg = hours2deg(hrs);
        [h, hm, hs] = deg2hms(hrs);
        [d, dm, ds] = deg2hms(deg);
    }
    if (degree != null) {
        deg = parseFloat(degree);
        if (Number.isNaN(deg)) {
            deg = 0;
        }
        hrs = deg2hours(deg);
        [h, hm, hs] = deg2hms(hrs);
        [d, dm, ds] = deg2hms(deg);
    }
    // set values
    if (hour == null)
        elHours.value = hrs.toFixed(4) + 'h';
    if (degree == null)
        elDegrees.value = deg.toFixed(4) + '\u00b0';
    if (dms == null)
        elDms.value = formatDMS(d, dm, ds);
    if (hms == null)
        elHms.value = formatHMS(h, hm, hs);

    drawHorizontal();

}


function drawFunction() {
    var x0 = docFloat('#x0');
    var x1 = docFloat('#x1');
    var n = docInt('#count');
    var f = docFunction('#function', 'x');
    if (typeof(f) !== 'function') {
        // TODO
        alert("Error: invalid function!");
        return;
    }
    chart.grid().data(getEquidistant(x0, x1, n), f).show();
}


function drawPolarFunction() {
    let x0 = docFloat('#x0'),
        x1 = docFloat('#x1'),
        n = docInt('#count'),
        f = docFunction('#function', 'x');
    if (typeof(f) !== 'function') {
        throw ("Error: invalid function!");
    }
    let xs = [], ys = [], radius;
    for (let angle of getEquidistant(x0, x1, n)) {
        radius = f(angle);
        xs.push(radius * cos(angle));
        ys.push(radius * sin(angle));
    }
    chart.grid().data(xs, ys).show();
}


function drawParametricFunction() {
    var xt = docFunction("#function-x-t", 't');
    var yt = docFunction("#function-y-t", 't');
    if (typeof(xt) !== 'function' || typeof(yt) !== 'function') {
        alert("Error: invalid function!");
        return;
    }
    var t0 = docFloat("#t0");
    var t1 = docFloat("#t1");
    var n = docInt("#count-t");
    var ts = getEquidistant(t0, t1, n);
    chart.grid().data(ts.map(xt), ts.map(yt)).show();
}

function drawHorizontal() {
    let radius = 10;
    chart.cleanup();
    var x, y, z, d;
    // углы - как в Вики:
    // угол тета - от оси Z вниз
    // угол фи - от оси X против часовой
    // горизонтальная сетка
    for (var t=0; t<=180; t+=15) {
        let xs = [], ys = [];
        for (var f=90; f<=270; f+=5) {
            [x,y,z] = sphericalToCartesian(t, f, radius);
            xs.push(y);
            ys.push(z);
        }
        chart.data(xs, ys, {type:'line', color:'#d0d0d0'});
    }
    // вертикальная сетка
    for (var f=90; f<=270; f+=15) {
        let xs = [], ys = [];
        for (var t=0; t<=180; t+=5) {
            [x,y,z] = sphericalToCartesian(t, f, radius);
            xs.push(y);
            ys.push(z);
        }
        chart.data(xs, ys, {type:'line', color:'#d0d0d0'});
    }
    chart.show();
}


function cleanup() {
    chart.cleanup();
}

// function gridToPolar() {
//     setFrame();
//     for (var r=PolarRadius; r>0; r-=PolarRadius/9) {
//         svgCircle(Grid, 0, 0, r, {class: 'grid'});
//     }
//     for (var a=0; a<180; a+=15) {
//         svgStraightLine(Grid, -PolarRadius, 0, 2*PolarRadius, 0, {
//             class: 'grid',
//             transform: 'rotate('+a+')'});
//     }
// }

        </script>
    </head>

<body onload="start()">

    <div class="tab">
        <button class="tablinks" onclick="cleanup()">очистить</button>
        <button class="tablinks active" onclick="showTab(event, 'univariate-tab')">y = f(x)</button>
        <button class="tablinks" onclick="showTab(event, 'parametric-tab')">x(t) y(t)</button>
        <button class="tablinks" onclick="showTab(event, 'angular-tab')">углы</button>
    </div>

<div id='content'>

    <div id='drawing-area'>
        <!-- TODO: reset sizes in js -->
        <svg
            id="map"
            width="500"
            height="400"
            version="1.1"
            viewBox="0 0 500 400"
            xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink">
        </svg>

    </div>


    <div id="input-area">
        <div id="univariate-tab" class="tabcontent">
            <h2>Задать аналитически</h2>
                <ul class="options">
                <li>
                    <a href="#" onclick="cleanup();">
                        <span>очистить</span>
                    </a>
                </li>
                <!-- y = f(x)-->
                <li>y = f(x)</li>
                <li>
                    <span class='label'>f(x) = </span>
                    <textarea id="function" spellcheck="false" rows="5" cols="30"
                        style='width:200px; height:50px; display:block;'>x
                    </textarea>
                    <!--input type="text" id='function' name="function"
                            list="functionslist">
                    <datalist id="functionslist">
                        <option value="x"></option>
                        <option value="Math.sin(x)"></option>
                        <option value="Math.exp(x)"></option>
                        <option value="/*Sinus in degrees*/ Math.sin(Math.PI/180*x)"></option>
                    </datalist-->
                </li>
                <li>
                    <span class='label'>x = [</span>
                    <input type='text' id='x0' value='0' style='width:40px'></input>
                    <span class='label'>,</span>
                    <input type='text' id='x1' value='10' style='width:40px'></input>
                    <span class='label'>]</span>
                </li>
                <li>
                    <input type="text" id='count' style='width:40px'></input>
                    <span class='label'>точек</span>
                </li>
                <li>
                    <a href="#" onclick="drawFunction();">
                        <span>построить y = f(x)</span>
                    </a>
                </li>
                <li>
                    <a href="#" onclick="drawPolarFuncti, 800, 6on();">
                        <span>построить в полярных</span>
                    </a>
                </li>
            </ul>
        </div>


        <div id="parametric-tab" class="tabcontent">
            <h2>Задать параметрически</h2>
            <ul class="options">
                <li>
                    <span class='label'>&nbsp;</span>
                </li>
                <!-- y = f(x)-->
                <li>x = f(t); y = g(t);</li>
                <li>
                    <span class='label'>x(t) = </span>
                    <textarea id="function-x-t" rows="5" cols="30" spellcheck="false"
                        style='width:200px; height:50px; display:block;'>2*t
                    </textarea>
                    <span class='label'>y(t) = </span>
                    <textarea id="function-y-t" rows="5" cols="30" spellcheck="false"
                        style='width:200px; height:50px; display:block;'>3*t
                    </textarea>
                </li>
                <li>
                    <span class='label'>t = [</span>
                    <input type='text' id='t0' value='0' style='width:40px'></input>
                    <span class='label'>,</span>
                    <input type='text' id='t1' value='10' style='width:40px'></input>
                    <span class='label'>]</span>
                </li>
                <li>
                    <input type="text" id='count-t' style='width:40px' value='10'></input>
                    <span class='label'>точек</span>
                </li>
                <li>
                    <a href="#" onclick="drawParametricFunction();">
                        <span>построить x(t) y(t)</span>
                    </a>
                </li>
            </ul>
        </div>


    <div id="angular-tab" class="tabcontent">
        <h2>Перевод углов</h2>
        <table id="angulars" style="margin:auto;">
            <tr>
                <td><input type='text' id='hms' value='0' style='width:120px'
                    oninput='translateAngular(null, null, this.value, null);'/></td>
            </tr>
            <tr>
                <td><input type='text' id='hours' value='0' style='width:120px'
                    oninput='translateAngular(this.value, null, null, null);'/></td>
            </tr>
            <tr>
                <td><input type='text' id='dms' value='0' style='width:120px'
                    oninput='translateAngular(null, null, null, this.value);'/></td>
            </tr>
            <tr>
                <td><input type='text' id='degrees' value='0' style='width:120px'
                    oninput='translateAngular(null, this.value, null, null);'/></td>
            </tr>
        </table>
    </div>

    </div>

</div>



</body>
</html>
